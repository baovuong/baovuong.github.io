<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <title>Sorting</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <style type="text/css">
        #sortingvisual {
            border-style: solid;
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
    </style>
    <script type="text/javascript">

        function arrayToForm(array,paramName) {
        	var result = "";
        	for (var i=0; i<array.length; i++) {
        		result += paramName + "=" + array[i];
        		if (i < array.length-1)
        			result += "&";
        	}
        	
        	return result;
        }

        function selectionSort(arrayInput) {
            var steps = new Array();
            steps.push({'values': arrayInput.slice(0)});
            var n = arrayInput.length;
            for (var j=0; j<n-1; j++) {
                var iMin = j;
                for (var i = j+1; i<n; i++) {
                    steps.push({'values': arrayInput.slice(0), 'focused': i})
                    if (arrayInput[i] < arrayInput[iMin]) {
                        iMin = i;
                    }
                }
                if (iMin != j) {
                    var temp = arrayInput[j];
                    arrayInput[j] = arrayInput[iMin];
                    arrayInput[iMin] = temp;
                    steps.push({'values': arrayInput.slice(0)});
                }
            }

            steps.push({'values': arrayInput.slice(0)});
            return steps;
        }
        
        function insertionSort(arrayInput) {
            var steps = new Array();
            steps.push({'values': arrayInput.slice(0)});
            for (var i=0; i<arrayInput.length; i++) {
                var key = arrayInput[i];
                var j = i - 1;
                while (j >= 0 && arrayInput[j] > key) {
                    steps.push({'values': arrayInput.slice(0), 'focused': j});
                    arrayInput[j+1] = arrayInput[j];
                    j = j-1;
                    steps.push({'values': arrayInput.slice(0)});
                }
                arrayInput[j+1] = key;
                steps.push({'values': arrayInput.slice(0)});
            }
            return steps;
        }

        function merge(arr, l, m, r, steps) {
            var n1 = m - l + 1;
            var n2 = r - m;

            var L = new Array();
            var R = new Array();
            for (var i = 0; i < n1; i++)
                L.push(arr[l + i]);
            for (var j = 0; j < n2; j++)
                R.push(arr[m + 1 + j]);
            
            var i = 0;
            var j = 0;
            var k = l;

            while (i < n1 && j < n2) {
                if (L[i] <= R[j]) {
                    arr[k] = L[i];
                    i++;
                }
                else {
                    arr[k] = R[j];
                    j++;
                }
                steps.push({'values': arr.slice(0), 'focused': k})
                k++;
                steps.push({'values': arr.slice(0)});
            }

            while (i < n1) {
                arr[k] = L[i];
                steps.push({'values': arr.slice(0)});
                i++;
                k++;
            }

            while (j < n2) {
                arr[k] = R[j];
                steps.push({'values': arr.slice(0)});
                j++;
                k++;
            }
            steps.push({'values': arr.slice(0)});
            return steps;
        }

        function min(x,y) {
            return (x < y) ? x : y;
        }

        function mergeSort(arr, l=0, r=-1, steps=null) {
            if (r == -1 && steps == null) {
                r = arr.length-1;
            }
            if (steps == null) {
                steps = new Array();
                steps.push({'values': arr.slice(0)});
            }

            if (l < r) {
                var m = Math.floor(l + (r-l)/2);
                mergeSort(arr, l, m, steps);
                mergeSort(arr, m+1, r, steps);
                merge(arr, l, m, r, steps);
            }
            return steps;
        }

        function partition(arr, l, h, steps) {
            var x = arr[h];
            var i = l - 1;

            for (var j=l; j <= h-1; j++) {
                steps.push({'values': arr.slice(0), 'focused': j})
                if (arr[j] <= x) {
                    i++;
                    // swap
                    var temp = arr[i];
                    arr[i] = arr[j];
                    arr[j] = temp;
                    steps.push({'values': arr.slice()});
                }
            }
            // swap
            var temp = arr[i+1];
            arr[i+1] = arr[h];
            arr[h] = temp;
            steps.push({'values': arr.slice()});

            return (i+1);
        }

        function quickSort(arr, l=0, h=-1, steps=null) {
            if (h == -1 && steps == null) {
                h = arr.length-1;
            }
            if (steps == null) {
                steps = new Array();
                steps.push({'values': arr.slice()});
            }

            if (l < h) {
                var p = partition(arr, l, h, steps);
                quickSort(arr, l, p - 1, steps);
                quickSort(arr, p + 1, h, steps);
            }
            return steps;
        }

        
            
        
        
            
    </script>
</head>

<body>
    <div class="container" id="main">
        <div class="row">
            <div class="col-sm-6">
                <select id="numSamples" class="form-control">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                </select>
            </div>
            <div class="col-sm-6">
                <button id="generatebutton" type="button" class="btn btn-block btn-secondary">Generate</button>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <select id="sortselect" class="form-control">
                    <option value="insertion">Insertion Sort</option>
                    <option value="selection">Selection Sort</option>
                    <option value="merge">Merge Sort</option>
                    <option value="quick">Quick Sort</option>
                </select>
            </div>
            <div class="col-sm-6">
                <button id="sortbutton" type="button" class="btn btn-block btn-primary">Sort</button>
            </div>
        </div>
        <!--<button id="stopbutton">Stop Sort</button><br/>-->
    </div>
    <canvas id="sortingvisual"></canvas>
    <script>
        var canvas = document.getElementById('sortingvisual');
        canvas.width = window.innerWidth*0.8;
        canvas.height = window.innerHeight*0.5;
        var ctx = canvas.getContext('2d');


        var sortButton = document.getElementById("sortbutton");
        var generateButton = document.getElementById("generatebutton");
        sortButton.disabled = true;
        
        var sortingInterval = null;
        var index;
        var steps;


        window.onresize=function() {
            canvas.width = window.innerWidth*0.8;
            canvas.height = window.innerHeight*0.5;
        };

        function displaySamples(samples) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);       
            var sampleWidth = canvas.width/samples.length;
            var largest = Math.max.apply(null,samples);
            for (var i=0; i<samples.length; i++) {
                var sampleHeight = (samples[i]*canvas.height)/largest;
                ctx.fillStyle = "#4E4EFF";
                ctx.lineStyle = "#4E4EFF";
                ctx.fillRect(i*sampleWidth,canvas.height-sampleHeight,sampleWidth,sampleHeight);
            }
            
        }
        
        function displayStep(step) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);        
            var sampleWidth = canvas.width/step.values.length;
            var largest = Math.max.apply(null,step.values);
            for (var i=0; i<step.values.length; i++) {
                var sampleHeight = (step.values[i]*canvas.height)/largest;
                if (step.focused == i) ctx.fillStyle = "#FFC100";
                else ctx.fillStyle = "#4E4EFF";
                ctx.lineStyle = "#4E4EFF";
                ctx.fillRect(i*sampleWidth,canvas.height-sampleHeight,sampleWidth,sampleHeight);
            }
        }


        function visualizeStep() {
        	console.log("visualizing");
            if (index < steps.length) {
                displayStep(steps[index]);
                index++;
            } else {
            	console.log("ending");
                clearInterval(sortingInterval);
                generateButton.disabled = false;
            }
        }
        
        function startSortingVisualization(samples) {
        	var sortingAlgorithmSelection = document.getElementById("sortselect");
        	var sortingAlgorithm = sortingAlgorithmSelection.options[sortingAlgorithmSelection.selectedIndex].value;
        	
            var xmlhttp;
            if (window.XMLHttpRequest) {
                xmlhttp = new XMLHttpRequest();
            } else {
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = function() {
            	console.log("doing the thing");
                if (xmlhttp.readyState==4 && xmlhttp.status==200) {
                    // do the sort
                    console.log("sorting");
                    var result = JSON.parse(xmlhttp.responseText);
                    console.log(result);
                    steps = result.steps;
                    index = 0;
                    sortingInterval = setInterval(visualizeStep,1);                    
                }
            }
            //var data = JSON.stringify({sample:randomSamples});
            //var data = "sample=4&sample=3";
            data = arrayToForm(randomSamples,"sample");
            xmlhttp.open("POST", "api/sort/"+sortingAlgorithm);
            xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            console.log(data);
            xmlhttp.send(data);
        }
        
        var randomSamples;
        
        generateButton.addEventListener("click",function() {
            var numSamplesSelect = document.getElementById("numSamples");
            var numSamples = numSamplesSelect.options[numSamplesSelect.selectedIndex].value;
            randomSamples = new Array();
            for (var i=0; i<numSamples; i++) {
                randomSamples.push(Math.round((Math.random() * 1000) + 1));
            }
            displaySamples(randomSamples);
            sortButton.disabled = false;
        },false);
        
        sortButton.addEventListener("click",function() {
            sortButton.disabled = true;
            generateButton.disabled = true;
            // startSortingVisualization(randomSamples);
            var sortingAlgorithmSelection = document.getElementById("sortselect");
            var sortingAlgorithm = sortingAlgorithmSelection.options[sortingAlgorithmSelection.selectedIndex].value;
            if (sortingAlgorithm == 'selection')
                steps = selectionSort(randomSamples);
            else if (sortingAlgorithm == 'insertion')
                steps = insertionSort(randomSamples);
            else if (sortingAlgorithm == 'merge')
                steps = mergeSort(randomSamples);
            else if (sortingAlgorithm == 'quick')
                steps = quickSort(randomSamples);
            index = 0;
            sortingInterval = setInterval(visualizeStep,1);      
        },false);
    </script>
</body>

</html>