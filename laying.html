<html>

<head>
    <title>Laying the Eggs</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
            user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
        }
        .stage {
            position: absolute;
            margin-left: auto;
            margin-right: auto;
            left: 0;
            right: 0;
        }
        #bg {
            z-index: 0;
        }
        #fg {
            z-index: 1;
        }
    </style>
</head>

<body onload="init();">
    <h1>LAY THE EGGS</h1>
    <p>
        just lay the eggs.
    </p>
    <canvas id="bg" class="stage" width="640" height="480"></canvas>
    <canvas id="fg" class="stage" width="640" height="480"></canvas>
</body>
<script type="text/javascript" src="js/Box2D.js"></script>
<script type="text/javascript">
    var b2Vec2 = Box2D.Common.Math.b2Vec2,
        b2BodyDef = Box2D.Dynamics.b2BodyDef,
        b2Body = Box2D.Dynamics.b2Body,
        b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
        b2Fixture = Box2D.Dynamics.b2Fixture,
        b2World = Box2D.Dynamics.b2World,
        b2MassData = Box2D.Collision.Shapes.b2MassData,
        b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
        b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
        b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
		b2Transform = Box2D.Common.Math.b2Transform,
		b2Mat22 = Box2D.Common.Math.b2Mat22;
</script>

<script type="text/javascript">

    function round(num) {
        return (0.5 + num) | 0;
    }

    function ImageBall(world, src, width, height, x, y) {
		var body = null;
		this.width = width;
		this.height = height;
		this.image = new Image();
		this.image.src = src;
		
		// body
		var bodyDef = new b2BodyDef();
		bodyDef.type = b2Body.b2_dynamicBody;
		bodyDef.position.x = x;
		bodyDef.position.y = y;
		this.body = world.CreateBody(bodyDef);

		// fixtures
		var fixDef = new b2FixtureDef();
		fixDef.shape = new b2PolygonShape();
		var vectors = new Array();
		var angle = Math.PI/3;
		var mh = this.height*Math.sin(angle);
		var mw = this.width*Math.cos(angle);
		
		vectors.push(new b2Vec2(-1 * width, 0));
		vectors.push(new b2Vec2(-1*mw, -1*mh));
		
		vectors.push(new b2Vec2(0, -1 * height));
		vectors.push(new b2Vec2(mw, -1*mh));
		
		vectors.push(new b2Vec2(width, 0));
		vectors.push(new b2Vec2(mw, mh));
		
		vectors.push(new b2Vec2(0, height));
		vectors.push(new b2Vec2(-1*mw, mh));
		
		fixDef.shape.SetAsArray(vectors);
		fixDef.density = 1;
		this.body.CreateFixture(fixDef);        
    }
    ImageBall.prototype.render=function(ctx, scale) {
		var pos = this.body.GetPosition();
		this.image.height = this.height*scale;
		this.image.width = this.width*scale;
        ctx.save();
        //ctx.translate(pos.x*scale, pos.y*scale);
         // optimized
        ctx.translate(round(pos.x*scale), round(pos.y*scale));


        ctx.rotate(this.body.GetAngle());
        ctx.drawImage(this.image, -1*this.image.width, -1*this.image.height, this.image.width*2, this.image.height*2);
        ctx.restore();
    };

    function TestBox(world, width, height, x, y) {
        this.width=width;
        this.height=height;
		// body
		var bodyDef = new b2BodyDef();
		bodyDef.type = b2Body.b2_dynamicBody;
		bodyDef.position.x = x;
		bodyDef.position.y = y;
		this.body = world.CreateBody(bodyDef);

		// fixture
		var shape = new b2PolygonShape();
		shape.SetAsBox(width, height, 0.5);
		var fixDef = new b2FixtureDef();
		fixDef.shape = shape;
		fixDef.density = 1;
		this.body.CreateFixture(fixDef);
    }
    TestBox.prototype.render=function(ctx, scale) {
		var pos = this.body.GetPosition();
        var angle = this.body.GetAngle();
		ctx.save();

		ctx.translate(pos.x * scale, pos.y * scale);
		ctx.rotate(angle);
		
        ctx.beginPath();
		ctx.moveTo(-1 * this.width * scale, -1 * this.height * scale);
		ctx.lineTo(this.width * scale, -1 * this.height * scale);
		ctx.lineTo(this.width * scale, this.height * scale);
		ctx.lineTo(-1 * this.width * scale, this.height * scale);
		ctx.lineTo(-1 * this.width * scale, -1 * this.height * scale);
		ctx.closePath();
        ctx.strokeStyle = '#000000';
		ctx.stroke();

		ctx.restore();
    };


	function Platform(world, width, height, x, y) {
		this.body = null;
		this.width = width;
		this.height = height;

		// body
		var bodyDef = new b2BodyDef();
		bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.x = x;
		bodyDef.position.y = y;
		this.body = world.CreateBody(bodyDef);

		// fixture
		var shape = new b2PolygonShape();
		shape.SetAsBox(width, height, 0.5);
		var fixDef = new b2FixtureDef();
		fixDef.shape = shape;
		fixDef.density = 1;
		this.body.CreateFixture(fixDef);
	}
	Platform.prototype.render=function(ctx, scale) {
		var pos = this.body.GetPosition();
		ctx.save();
		ctx.fillStyle = '#555555';
		ctx.translate(pos.x * scale, pos.y * scale);
		ctx.rotate(this.body.GetAngle());
		ctx.beginPath();
		ctx.moveTo(-1 * this.width * scale, -1 * this.height * scale);
		ctx.lineTo(this.width * scale, -1 * this.height * scale);
		ctx.lineTo(this.width * scale, this.height * scale);
		ctx.lineTo(-1 * this.width * scale, this.height * scale);
		ctx.lineTo(-1 * this.width * scale, -1 * this.height * scale);
		ctx.closePath();
		ctx.fill();
		ctx.restore();		
	};


    function Nest(world, width, height, x, y) {

    }
    Nest.prototype = Object.create(Platform.prototype);
	Nest.prototype.constructor = Platform;

    Nest.prototype.render=function(ctx, scale) {

    };

    function randInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min);
    }

    var world;
    
    var bgCanvas = document.getElementById('bg');
    var bgCtx = bgCanvas.getContext('2d');
    var fgCanvas = document.getElementById('fg');
    var fgCtx = fgCanvas.getContext('2d');

    var parts = new Array();
    var bgObjects = new Array();
    var fgObjects = new Array();

    var hen = new Image();
    hen.src = 'img/hen.png';
    hen.width = 48;
    hen.height = 48;
    var henX = 0;
    var henY = 0;
    var scale = 30;
    
    var backgroundImage = new Image();

    // cool art bro: http://austriaangloalliance.deviantart.com/art/Barn-Inside-With-Hay-357489378
    backgroundImage.src = 'img/barn_inside.jpg';
    

    // sounds
    var cannonSound = new Audio();
    cannonSound.src = 'aud/cannon.mp3';

    var blopSound = new Audio();
    blopSound.src = 'aud/blop.mp3';

    var maxVelocity = 0;

    var numDiamond = 0;
    var numGolden = 0;
    var numRainbow = 0;
    var numRegular = 0;


    function init() {
        world = new b2World(new b2Vec2(0, 50),true);

        window.onresize=function() {
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);

            bgCanvas.width = round(window.innerWidth * 0.85); 
            bgCanvas.height = round(window.innerHeight * 0.85); 
            fgCanvas.width = bgCanvas.width; 
            fgCanvas.height = bgCanvas.height; 
            maxVelocity = new b2Vec2(0.2*fgCanvas.width*2, 0.2*fgCanvas.height*0.1).Length();
            for (var i=0; i<bgObjects.length; i++) {
                bgObjects[i].body.GetWorld().DestroyBody(bgObjects[i].body);
            }
            bgObjects = new Array();

            bgObjects.push(new Platform(world, bgCanvas.width, 0.1, 0, (bgCanvas.height-2)/scale));
            bgObjects.push(new Platform(world, bgCanvas.width, 0.1, 0, 0));
            bgObjects.push(new Platform(world, 0.1, bgCanvas.height, 0, 0));
            bgObjects.push(new Platform(world, 0.1, bgCanvas.height, (bgCanvas.width-2)/scale, 0));
            //for (var i=0; i<bgObjects.length; i++) {
            //    bgObjects[i].render(bgCtx, scale);
            //}

            // rendering background
            bgCtx.drawImage(backgroundImage, 0, 0, bgCanvas.width, bgCanvas.height);
        };

        window.onresize();

        fgCanvas.addEventListener('mousemove', function(evt) {
            //fgCtx.clearRect(henX - hen.width, henY - hen.height, hen.width*2, hen.height*2);
            var rect = fgCanvas.getBoundingClientRect();
            henX = evt.pageX - rect.left;
            henY = evt.pageY - rect.top;

        });


        fgCanvas.addEventListener('click', function(evt) {
            // lay the egg

            var newEgg;
            var newEggImage;
            
            var choice = Math.floor(Math.random()*100)+1;
            if (choice >= 1 && choice <= 5) {
                newEggImage = 'img/diamond-egg.png';
                numDiamond++;
            } else if (choice >= 6 && choice <= 15) {
                newEggImage = 'img/golden-egg.png';
                numGolden++;
            } else if (choice >= 16 && choice <= 35) {
                newEggImage = 'img/rainbow-egg.png';
                numRainbow++;
            } else {
                newEggImage = Math.random() > 0.5 ? 'img/white-egg.png' : 'img/brown-egg.png';
                numRegular++;
            }
            newEgg = new ImageBall(world, newEggImage, 24/scale, 32/scale, henX/scale, henY/scale);
            
            fgObjects.push(newEgg);

            var force = new b2Vec2(randInt(10,0.2*fgCanvas.width*2) , randInt(5, 0.2*fgCanvas.height*0.1));

            newEgg.body.ApplyImpulse(force, newEgg.body.GetWorldCenter());
            newEgg.body.ApplyTorque(randInt(500, 5000));

            if (force.Length() >= maxVelocity*0.45) {
                cannonSound.currentTime = 0;
                cannonSound.play();
            } else {
                blopSound.currentTime = 0;
                blopSound.play();
            }

        });

        window.setInterval(update, 1000 / 60);
    }

    function update() {
        fgCtx.clearRect(0, 0, fgCanvas.width, fgCanvas.height);



        world.Step(1/60, 10, 10);
        for (var i=0; i<fgObjects.length; i++) {
            fgObjects[i].render(fgCtx, scale);
        }
        world.ClearForces();

        // drawing the chicken
        fgCtx.save();
	    //fgCtx.translate(henX, henY);
        
        // optimized
        fgCtx.translate(round(henX), round(henY));
        fgCtx.drawImage(hen, -1*hen.width, -1*hen.height, hen.width*2, hen.height*2);
		fgCtx.restore();
    }


</script>
</html>