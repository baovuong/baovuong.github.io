<html>

<head>
    <title>Laying the Eggs</title>
</head>

<body onload="init();">
    <div>
        <canvas id="bg" width="600" height="400" style="position: absolute; z-index: 0"></canvas>
        <canvas id="fg" width="600" height="400" style="position: absolute; z-index: 1"></canvas>
    </div>

</body>
<script type="text/javascript" src="js/Box2D.js"></script>
<script type="text/javascript">
    var b2Vec2 = Box2D.Common.Math.b2Vec2,
        b2BodyDef = Box2D.Dynamics.b2BodyDef,
        b2Body = Box2D.Dynamics.b2Body,
        b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
        b2Fixture = Box2D.Dynamics.b2Fixture,
        b2World = Box2D.Dynamics.b2World,
        b2MassData = Box2D.Collision.Shapes.b2MassData,
        b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
        b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
        b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
		b2Transform = Box2D.Common.Math.b2Transform,
		b2Mat22 = Box2D.Common.Math.b2Mat22;
</script>

<script type="text/javascript">

    function ImageBall(world, src, width, height, x, y) {
		var body = null;
		this.width = width;
		this.height = height;
		this.image = new Image();
		this.image.src = src;
		
		// body
		var bodyDef = new b2BodyDef();
		bodyDef.type = b2Body.b2_dynamicBody;
		bodyDef.position.x = x;
		bodyDef.position.y = y;
		this.body = world.CreateBody(bodyDef);

		// fixtures
		var fixDef = new b2FixtureDef();
		fixDef.shape = new b2PolygonShape();
		var vectors = new Array();
		var angle = Math.PI/3;
		var mh = this.height*Math.sin(angle);
		var mw = this.width*Math.cos(angle);
		
		vectors.push(new b2Vec2(-1 * width, 0));
		vectors.push(new b2Vec2(-1*mw, -1*mh));
		
		vectors.push(new b2Vec2(0, -1 * height));
		vectors.push(new b2Vec2(mw, -1*mh));
		
		vectors.push(new b2Vec2(width, 0));
		vectors.push(new b2Vec2(mw, mh));
		
		vectors.push(new b2Vec2(0, height));
		vectors.push(new b2Vec2(-1*mw, mh));
		
		fixDef.shape.SetAsArray(vectors);
		fixDef.density = 1;
		this.body.CreateFixture(fixDef);        
    }
    ImageBall.prototype.render=function(ctx, scale) {
		var pos = this.body.GetPosition();
		this.image.height = this.height*scale;
		this.image.width = this.width*scale;
        ctx.save();
        ctx.translate(pos.x*scale, pos.y*scale);
        ctx.rotate(this.body.GetAngle());
        ctx.drawImage(this.image, -1*this.image.width, -1*this.image.height, this.image.width*2, this.image.height*2);
		ctx.restore();
    };
    ImageBall.prototype.clear=function(ctx, scale) {

    }


	function Platform(world, width, height, x, y) {
		this.body = null;
		this.width = width;
		this.height = height;

		// body
		var bodyDef = new b2BodyDef();
		bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.x = x;
		bodyDef.position.y = y;
		this.body = world.CreateBody(bodyDef);

		// fixture
		var shape = new b2PolygonShape();
		shape.SetAsBox(width, height, 0.5);
		var fixDef = new b2FixtureDef();
		fixDef.shape = shape;
		fixDef.density = 1;
		this.body.CreateFixture(fixDef);
	}
	Platform.prototype.render=function(ctx, scale) {
		var pos = this.body.GetPosition();
		ctx.save();
		ctx.fillStyle = '#555555';
		ctx.translate(pos.x * scale, pos.y * scale);
		ctx.rotate(this.body.GetAngle());
		ctx.beginPath();
		ctx.moveTo(-1 * this.width * scale, -1 * this.height * scale);
		ctx.lineTo(this.width * scale, -1 * this.height * scale);
		ctx.lineTo(this.width * scale, this.height * scale);
		ctx.lineTo(-1 * this.width * scale, this.height * scale);
		ctx.lineTo(-1 * this.width * scale, -1 * this.height * scale);
		ctx.closePath();
		ctx.fill();
		ctx.restore();		
	}

    function randInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min);
    }

    var world;
    
    var bgCanvas = document.getElementById('bg');
    var bgCtx = bgCanvas.getContext('2d');
    var fgCanvas = document.getElementById('fg');
    var fgCtx = fgCanvas.getContext('2d');

    var parts = new Array();
    var bgObjects = new Array();
    var fgObjects = new Array();

    var hen = new Image();
    hen.src = 'img/hen.png';
    hen.width = 60;
    hen.height = 60;
    var henX = 0;
    var henY = 0;
    var scale = 30;
    var eggImages = ['img/brown-egg.png', 'img/white-egg.png', 'img/rainbow-egg.png', 'img/golden-egg.png', 'img/diamond-egg.png'];
    
    var numDiamond = 0;
    var numGolden = 0;
    var numRainbow = 0;
    var numRegular = 0;


    function init() {
        window.onresize=function() {
            fgCanvas.width = window.innerWidth;
            fgCanvas.height = window.innerHeight;
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
        };

        window.onresize();
        world = new b2World(new b2Vec2(0, 50),true);
        
        bgObjects.push(new Platform(world, fgCanvas.width, 0.1, 0, (fgCanvas.height-2)/scale));
        bgObjects.push(new Platform(world, fgCanvas.width, 0.1, 0, 0));
        bgObjects.push(new Platform(world, 0.1, fgCanvas.height, 0, 0));
        bgObjects.push(new Platform(world, 0.1, fgCanvas.height, (fgCanvas.width-2)/scale, 0));

        fgCanvas.addEventListener('mousemove', function(evt) {
            henX = evt.pageX;
            henY = evt.pageY;
        });

        fgCanvas.addEventListener('click', function(evt) {
            // lay the egg
            var newEgg;
            var newEggImage;
            var choice = Math.floor(Math.random()*100)+1;
            if (choice >= 1 && choice <= 5) {
                newEggImage = 'img/diamond-egg.png';
                numDiamond++;
            } else if (choice >= 6 && choice <= 15) {
                newEggImage = 'img/golden-egg.png';
                numGolden++;
            } else if (choice >= 16 && choice <= 35) {
                newEggImage = 'img/rainbow-egg.png';
                numRainbow++;
            } else {
                newEggImage = Math.random() > 0.5 ? 'img/white-egg.png' : 'img/brown-egg.png';
                numRegular++;
            }
            newEgg = new ImageBall(world, newEggImage, 30/scale, 40/scale, henX/scale, henY/scale);
            fgObjects.push(newEgg);

            var force = new b2Vec2(randInt(10,250) , randInt(10, 200));
            newEgg.body.ApplyImpulse(force, newEgg.body.GetWorldCenter());
            newEgg.body.ApplyTorque(randInt(500, 5000));
        });
        //setup debug draw
        /*
        var debugDraw = new b2DebugDraw();
        debugDraw.SetSprite(ctx);
        debugDraw.SetDrawScale(30.0);
        debugDraw.SetFillAlpha(0.5);
		debugDraw.SetAlpha(0.5);
        debugDraw.SetLineThickness(3.0);
        debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
        world.SetDebugDraw(debugDraw);
        */

        for (var i=0; i<bgObjects.length; i++) {
            bgObjects[i].render(bgCtx, scale);
        }

        window.setInterval(update, 1000 / 60);
    }

    function update() {
        world.Step(1/60, 10, 10);

        fgCtx.clearRect(0, 0, fgCanvas.width, fgCanvas.height);
        //world.DrawDebugData();
        for (var i=0; i<fgObjects.length; i++) {
            fgObjects[i].render(fgCtx, scale);
        }
        world.ClearForces();

        // drawing the chicken
        fgCtx.save();
		fgCtx.translate(henX, henY);
        fgCtx.drawImage(hen, -1*hen.width, -1*hen.height, hen.width*2, hen.height*2);
		fgCtx.restore();
    }


</script>
</html>